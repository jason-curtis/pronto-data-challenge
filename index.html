<!DOCTYPE html>
<html>
  <head>
    <title>Geolocation</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>

html, body {
    height: 100%;
    margin: 0;
    padding: 0;
}
#map {
    height: 100%;
    width: 50%;
}
#controls {
    height: 100%;
    width: 50%;
}
#route-info {
  width: 150px;
  height: 100px;
  position: absolute;
  left: 0;
  top: 0;
}
</style>
  </head>
  <body>
    <div id="map"></div>
    <div id="controls"></div>
    <div id="route-info">route info</div>
    <script src="js/lib/lodash.min.js">
</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js">
</script>
    <script>

colors = {
  prontoGreen: '#8EDD65',
  prontoBlue: '#68D2DF',
  prontoDarkBlue: '#003B49'
}
function makeStationUseful(station) {
  // Available attrs: 
  // dockcount: "18"
  // id: "1"
  // lat: "47.618418"
  // long: "-122.350964"
  // name: "3rd Ave & Broad St"
  // online: "10/13/2014"
  // terminal: "BT-01"

  return {
      lat: Number(station.lat),
      lon: Number(station.long),
      name: station.name,
      id: station.terminal
  }
}
function getDataAndInitMap() {
  $.getJSON(
    "data/json/2015_station_data.json", 
    function(stations) {
        initMap(_.map(stations, makeStationUseful));
    }
  );
};
function initMap(stations) {
  var styles = [
    {
      stylers: [
        { hue: "#00ffe6" },
        { saturation: -20 }
      ]
    },
    {
      featureType: "road",
      elementType: "geometry",
      stylers: [
        { lightness: 100 },
        { visibility: "simplified" }
      ]
    },
    {
      featureType: "road",
      elementType: "labels",
      stylers: [
        { visibility: "off" }
      ]
    }
  ];
  var map = new google.maps.Map(document.getElementById('map'),{
      center: {
          lat: 47.6186455,
          lng: -122.3143096
      },
      zoom: 16,
      styles: styles,
//       mapTypeId: google.maps.MapTypeId.TERRAIN,
  });
  var bounds = new google.maps.LatLngBounds(
    new google.maps.LatLng(_.min(stations, 'lat').lat, _.min(stations, 'lon').lon),
    new google.maps.LatLng(_.max(stations, 'lat').lat, _.max(stations, 'lon').lon)
  );
  map.fitBounds(bounds);

//   var bikeLayer = new google.maps.BicyclingLayer();
//   bikeLayer.setMap(map);

  // Draw stations on the map
  stations.map(function(station) {
      new google.maps.Marker({
          position: {
              lat: Number(station.lat),
              lng: Number(station.lon)
          },
          map: map,
          title: station.name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 5,
            strokeColor: colors.prontoGreen,
            strokeOpacity: .9,
            strokeWeight: 2
          },
      });
  }
  )
  var stationsById = {};
  _.forEach(stations, function(station) {stationsById[station.id] = station})
  debugger;

  $.getJSON(
    "data/json/2015_trip_data.json", 
    function(trips) {
      $.getJSON(
        "data/json/trip_paths.json", 
        function(tripPaths) {
            initAnimation(map, _.map(trips, makeTripUseful), stationsById, tripPaths);
        }
      );
    }
  );

};

function makeTripUseful(trip) {
  // Full list of available attrs: 
  // trip_id,starttime,stoptime,bikeid,tripduration,from_station_name,to_station_name,from_station_id,to_station_id,usertype,gender,birthyear
  // times are in the format "10/13/2014 10:31", God bless America
  return {
    fromStationId: trip.from_station_id,
    toStationId: trip.to_station_id,
    duration: Number(trip.tripduration),
  }
};

function initAnimation(map, trips, stationsById, tripPaths) {
  /*
  map: a Google Map
  trips: trip objects passed through makeTripUseful
  stationsById: stations indexed by station ID
  tripPaths: arrays of LatLons indexed by pairs of station ID, describing a reasonable route between the stations
  */
  var trip = trips[0];

  
  var directionsService = new google.maps.DirectionsService;
  
  var delay=500; // milliseconds to prevent hitting Google API limit for the time being
  var startTrip=10000 // the first several trips are boring :p
  var maxTrips=10500 // also put a max on this
  var polyLines = {}
  var riderCounts = {}
  var cacheHits = 0
  var cacheMisses = 0
  var apiErrors = 0

  var arrowPct = 0;
  var arrowPctStep = 0.01;

  var maxRiders = 10 // Max number of riders to show on one path at a time
  var riderSeparation = 10 // in percent

  function getPolylineOptions(path, offsetFraction, riderCount) {
    var riderCountCiel = Math.min(riderCount, maxRiders)
    var lineSymbol = {
      path: google.maps.SymbolPath.FORWARD_OPEN_ARROW
    };
    function getIcon(riderIndex) {
      return {
        icon: lineSymbol,
        offset: (offsetFraction*100 + riderSeparation * riderIndex) % 100 + '%',
      }
    }
    var icons = _.times(riderCountCiel, getIcon)
    return {
      map: map,
      path: path,
      clickable: false, // Maybe this will ease some of the rendering load?
      icons: icons,
      strokeColor: colors.prontoDarkBlue,
      strokeOpacity: riderCountCiel * .1,
      strokeWeight: 1,
      visible: riderCount > 0,
    }
  }
  _.each(trips.slice(0,1000), registerTrip)
  function registerTrip(trip, i) {
    var fromStation = stationsById[trip.fromStationId];
    var toStation = stationsById[trip.toStationId];
    if (!toStation || !fromStation || (fromStation == toStation)){
      // not interested in special stuff like the bike share garage, or routes that end where they started
      return;
    }
    riderCounts[fromStation.id+toStation.id] = 
      riderCounts[fromStation.id+toStation.id] ?
      riderCounts[fromStation.id+toStation.id] + 1 : 1;
  }

  function getPath(fromStation, toStation) {
    if (tripPaths[fromStation.id + toStation.id]) {
      return tripPaths[fromStation.id + toStation.id]
    } else {
      return [
        {lat:fromStation.lat, lng: fromStation.lon},
        {lat:toStation.lat, lng: toStation.lon}
      ]
    }
  }

  function createPolyline(riderCount, stationIds) {
    var stationIdsSplit = /(\w+-\d+)(\w+-\d+)/.exec(stationIds)
    var fromStation = stationsById[stationIdsSplit[1]]
    var toStation = stationsById[stationIdsSplit[2]]
    var path = getPath(fromStation, toStation)

    polyLines[fromStation.id+toStation.id] = new google.maps.Polyline(
      getPolylineOptions(path, arrowPct, riderCount)
    )
  }
  _.map(riderCounts, createPolyline)

  window.setInterval(pushArrows, 20);
  function pushArrows() {
    arrowPct = (arrowPct + arrowPctStep) % 1;
    _.each(riderCounts, function(riderCount, stationIds) {
      var polyline = polyLines[stationIds]
      polyline.setOptions(
        getPolylineOptions(
          polyline.getPath(),
          arrowPct,
          riderCount
        )
      )
    })
  }
};


</script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOt84QlJQo1tPQqawpvWdsRvKyFfp9ahA&callback=getDataAndInitMap"
        async defer>
</script>
  </body>
</html>